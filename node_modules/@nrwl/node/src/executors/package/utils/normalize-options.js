"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs_extra_1 = require("fs-extra");
const devkit_1 = require("@nrwl/devkit");
const glob = require("glob");
const path_1 = require("path");
function normalizeOptions(options, context, libRoot) {
    const outDir = options.outputPath;
    const files = [];
    const globbedFiles = (pattern, input = '', ignore = []) => {
        return glob.sync(pattern, {
            cwd: input,
            nodir: true,
            ignore,
        });
    };
    options.assets.forEach((asset) => {
        if (typeof asset === 'string') {
            globbedFiles(asset, context.root).forEach((globbedFile) => {
                files.push({
                    input: path_1.join(context.root, globbedFile),
                    output: path_1.join(context.root, outDir, path_1.basename(globbedFile)),
                });
            });
        }
        else {
            globbedFiles(asset.glob, path_1.join(context.root, asset.input), asset.ignore).forEach((globbedFile) => {
                files.push({
                    input: path_1.join(context.root, asset.input, globbedFile),
                    output: path_1.join(context.root, outDir, asset.output, globbedFile),
                });
            });
        }
    });
    const rootDir = libRoot || '';
    if (options.main && !fs_extra_1.existsSync(options.main)) {
        throw new Error(`Please verify that the "main" option for project "${context.projectName}" is valid.`);
    }
    const mainFileDir = path_1.dirname(options.main);
    // Always include a preceding dot to match format used for entry points
    const relativeDir = devkit_1.normalizePath(path_1.relative(rootDir, mainFileDir));
    const relativeMainFileOutput = relativeDir === '' ? `./` : `./${relativeDir}/`;
    if (options.buildableProjectDepsInPackageJsonType == undefined) {
        options.buildableProjectDepsInPackageJsonType = 'dependencies';
    }
    return Object.assign(Object.assign({}, options), { files,
        relativeMainFileOutput, normalizedOutputPath: path_1.join(context.root, options.outputPath) });
}
exports.default = normalizeOptions;
//# sourceMappingURL=normalize-options.js.map